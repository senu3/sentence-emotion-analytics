import pandas as pd
import numpy as np
import streamlit as st
import requests
from io import StringIO
import plotly.graph_objects as go
import plotly.express as px

# APIå‘¼ã³å‡ºã—ã®çµæœã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ–
if 'api_result' not in st.session_state:
    st.session_state.api_result = None


# Streamlitã®ã‚¿ã‚¤ãƒˆãƒ«
st.sidebar.title('ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…åˆ†æ')

# è¦‹æœ¬ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆ
selected_item = st.sidebar.selectbox('ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ', 
    [
    '',
    'ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ',
    'å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼',
    'ãƒˆãƒ©ãƒ–ãƒ«',
    'å¾è¼©ã¯çŒ«ã§ã‚ã‚‹', 
    'è‰æ•', 
    'ãƒãƒ©ãƒ¼ãƒã®åºƒå ´'
    ],
    help='ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã®ã‚»ãƒƒãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™')

aozora_dict = {
    'ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ':"ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚é›¨ãŒé™ã£ã¦æ°—åˆ†ãŒã©ã‚“ã‚ˆã‚Šã€‚ã“ã‚“ãªæ™‚ã“ãç¬‘é¡”ãŒä¸€ç•ªï¼ç©ºãŒæ™´ã‚ŒãŸã‚‰è™¹ã‚‚ã‹ã‹ã£ãŸã€‚ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã«ãªã‚Šã¾ã—ãŸã€‚",
    'å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼':"ã“ã®ãƒªãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ ã€ã™ã£ã”ãè‰¯ã‹ã£ãŸã§ã™ï¼ã€€å”‡ãŒãƒ—ãƒ«ãƒ—ãƒ«ã«ãªã‚Šã¾ã—ãŸï¼ä½¿ç”¨æ„Ÿã‚‚è»½ã‚„ã‹ã§ã€å¡—ã‚Šå¿ƒåœ°ã¯æœ¬å½“ã«æ»‘ã‚‰ã‹ã€‚è‰²æŒã¡ã‚‚è‰¯ãã¦ã€æœå¡—ã‚Œã°å¤•æ–¹ã¾ã§ã—ã£ã‹ã‚Šè‰²ãŒæ®‹ã£ã¦ã„ã‚‹ã‚“ã§ã™ã€‚ãã‚Œã«ã€ã“ã®ãƒªãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ ã®é¦™ã‚Šï¼ã»ã‚“ã®ã‚Šç”˜ãã¦ã€ã¤ã‘ã¦ã„ã‚‹ã ã‘ã§æ°—åˆ†ãŒä¸ŠãŒã‚Šã¾ã™ã€‚åŒ…è£…ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã€æŒã¡æ­©ãã®ãŒå¬‰ã—ããªã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ã€‚ã§ã‚‚ã€ã¡ã‚‡ã£ã¨é«˜ã™ãã€‚ç¢ºã‹ã«å“è³ªã¯ã„ã„ã‘ã©ã€ä»–ã®ãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒªãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ ã¨æ¯”è¼ƒã™ã‚‹ã¨ã€ã‹ãªã‚Šé«˜ä¾¡ã€‚æ¯æ—¥ä½¿ã†ã‚‚ã®ã¨è€ƒãˆã‚‹ã¨å°‘ã—æ‰‹ãŒå‡ºã—ã¥ã‚‰ã„ä¾¡æ ¼è¨­å®šã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚ã¨ã€ç¨®é¡ãŒè±Šå¯Œã™ãã¦é¸ã³ã¥ã‚‰ã„ã¨ã„ã†å•é¡Œã‚‚ã€‚ã©ã‚ŒãŒè‡ªåˆ†ã«åˆã£ã¦ã„ã‚‹ã®ã‹è¿·ã£ã¦ã—ã¾ã„ã¾ã™ã€‚ãã‚Œã§ã‚‚ã€ã“ã®ãƒªãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ ã¯æœ€è¿‘ã®ä¸€æŠ¼ã—ã§ã™ã€‚ã¾ã è²·ã£ãŸã“ã¨ã®ãªã„äººã¯ä¸€åº¦è©¦ã—ã¦ã¿ã‚‹ã“ã¨ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚",
    'ãƒˆãƒ©ãƒ–ãƒ«':"çœ‹æ¿ã«ã‚½ãƒ•ãƒˆã‚¯ãƒªãƒ¼ãƒ å±‹ã¨ã‚ã‚‹ã®ã«ã€ã‚¢ã‚¤ã‚¹ãŒå…¨ããªã„ã®ã¯ã¡ã‚‡ã£ã¨é©šãã¾ã—ãŸã€‚æ­£ç›´ã€æœŸå¾…ã—ã¦ã„ãŸåˆ†ã€ãŒã£ã‹ã‚Šã¯ã—ã¾ã—ãŸã­ã€‚ã§ã‚‚ã€åº—å“¡ã•ã‚“ã‚‚å›°ã£ã¦ã„ã‚‹æ§˜å­ã§ã€ãƒã‚·ãƒ³ãŒå£Šã‚Œã¦ã—ã¾ã£ãŸã‚‰ã—ã„ã€‚ãã†ã„ã†ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆã¯ã©ã“ã«ã§ã‚‚ã‚ã‚‹ã“ã¨ã ã—ã€ä»•æ–¹ãªã„ã®ã‹ãªã¨ã‚‚æ€ã„ã¾ã™ã€‚ãŸã ã€ã›ã‚ã¦å…¥åº—å‰ã«ä½•ã‚‰ã‹ã®å‘ŠçŸ¥ãŒã‚ã‚Œã°ã€ã‚‚ã†å°‘ã—æ°—æŒã¡ã®æ•´ç†ã‚‚ã¤ã„ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚åº—å“¡ã•ã‚“ã®å¯¾å¿œã¯ã€çŠ¶æ³ã‚’è¸ã¾ãˆã‚Œã°ã€ã¾ãé ‘å¼µã£ã¦ã„ãŸæ–¹ã‹ãªã¨ã€‚ä»Šå›ã¯æº€è¶³ã„ãä½“é¨“ã§ã¯ãªã‹ã£ãŸã§ã™ãŒã€ä¿®ç†ãŒæ¸ˆã‚“ã ã‚‰ã€ã¾ãŸæ”¹ã‚ã¦è¶³ã‚’é‹ã‚“ã§ã¿ã‚ˆã†ã‹ãªã€ã¨ã¯æ€ã„ã¾ã™ã€‚æ¬¡ã“ãã¯ã€æœŸå¾…ã«å¿œãˆã¦ãã‚Œã‚‹ã¨ã„ã„ãªã¨æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚",
    'å¾è¼©ã¯çŒ«ã§ã‚ã‚‹':"å¾è¼©ã¯çŒ«ã§ã‚ã‚‹ã€‚åå‰ã¯ã¾ã ç„¡ã„ã€‚ã©ã“ã§ç”Ÿã‚ŒãŸã‹ã¨ã‚“ã¨è¦‹å½“ãŒã¤ã‹ã¬ã€‚ä½•ã§ã‚‚è–„æš—ã„ã˜ã‚ã˜ã‚ã—ãŸæ‰€ã§ãƒ‹ãƒ£ãƒ¼ãƒ‹ãƒ£ãƒ¼æ³£ã„ã¦ã„ãŸäº‹ã ã‘ã¯è¨˜æ†¶ã—ã¦ã„ã‚‹ã€‚å¾è¼©ã¯ã“ã“ã§å§‹ã‚ã¦äººé–“ã¨ã„ã†ã‚‚ã®ã‚’è¦‹ãŸã€‚ã—ã‹ã‚‚ã‚ã¨ã§èãã¨ãã‚Œã¯æ›¸ç”Ÿã¨ã„ã†äººé–“ä¸­ã§ä¸€ç•ªç°æ‚ªãªç¨®æ—ã§ã‚ã£ãŸãã†ã ã€‚ã“ã®æ›¸ç”Ÿã¨ã„ã†ã®ã¯æ™‚ã€…æˆ‘ã€…ã‚’æ•ãˆã¦ç…®ã¦é£Ÿã†ã¨ã„ã†è©±ã§ã‚ã‚‹ã€‚", 
    'è‰æ•':"å±±è·¯ã‚’ç™»ã‚ŠãªãŒã‚‰ã€ã“ã†è€ƒãˆãŸã€‚æ™ºã«åƒã‘ã°è§’ãŒç«‹ã¤ã€‚æƒ…ã«æ£¹ã•ã›ã°æµã•ã‚Œã‚‹ã€‚æ„åœ°ã‚’é€šã›ã°çª®å±ˆã ã€‚ã¨ã‹ãã«äººã®ä¸–ã¯ä½ã¿ã«ãã„ã€‚ä½ã¿ã«ãã•ãŒé«˜ã˜ã‚‹ã¨ã€å®‰ã„æ‰€ã¸å¼•ãè¶Šã—ãŸããªã‚‹ã€‚ã©ã“ã¸è¶Šã—ã¦ã‚‚ä½ã¿ã«ãã„ã¨æ‚Ÿã£ãŸæ™‚ã€è©©ãŒç”Ÿã‚Œã¦ã€ç”»ãŒå‡ºæ¥ã‚‹ã€‚", 
    'ãƒãƒ©ãƒ¼ãƒã®åºƒå ´':"ãã®ã“ã‚ã‚ãŸãã—ã¯ã€ãƒ¢ãƒªãƒ¼ã‚ªå¸‚ã®åšç‰©å±€ã«å‹¤ã‚ã¦å±…ã‚Šã¾ã—ãŸã€‚åå…«ç­‰å®˜ã§ã—ãŸã‹ã‚‰å½¹æ‰€ã®ãªã‹ã§ã‚‚ã€ãšã†ã£ã¨ä¸‹ã®æ–¹ã§ã—ãŸã—ä¿¸çµ¦ã‚‚ã»ã‚“ã®ã‚ãšã‹ã§ã—ãŸãŒã€å—æŒã¡ãŒæ¨™æœ¬ã®æ¡é›†ã‚„æ•´ç†ã§ç”Ÿã‚Œä»˜ãå¥½ããªã“ã¨ã§ã—ãŸã‹ã‚‰ã€ã‚ãŸãã—ã¯æ¯æ—¥ãšã„ã¶ã‚“æ„‰å¿«ã«ã¯ãŸã‚‰ãã¾ã—ãŸã€‚æ®Šã«ãã®ã“ã‚ã€ãƒ¢ãƒªãƒ¼ã‚ªå¸‚ã§ã¯ç«¶é¦¬å ´ã‚’æ¤ç‰©åœ’ã«æ‹µã“ã—ã‚‰ãˆç›´ã™ã¨ã„ã†ã®ã§ã€ãã®æ™¯è‰²ã®ã„ã„ã¾ã‚ã‚Šã«ã‚¢ã‚«ã‚·ãƒ¤ã‚’æ¤ãˆè¾¼ã‚“ã åºƒã„åœ°é¢ãŒã€åˆ‡ç¬¦å£²å ´ã‚„ä¿¡å·æ‰€ã®å»ºç‰©ã®ã¤ã„ãŸã¾ã¾ã€ã‚ãŸãã—ã©ã‚‚ã®å½¹æ‰€ã®æ–¹ã¸ã¾ã‚ã£ã¦æ¥ãŸã‚‚ã®ã§ã™ã‹ã‚‰ã€ã‚ãŸãã—ã¯ã™ãå®¿ç›´ã¨ã„ã†åå‰ã§æœˆè³¦ã§è²·ã£ãŸå°ã•ãªè“„éŸ³å™¨ã¨äºŒåæšã°ã‹ã‚Šã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã£ã¦ã€ãã®ç•ªå°å±‹ã«ã²ã¨ã‚Šä½ã‚€ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚ã‚ãŸãã—ã¯ãã“ã®é¦¬ã‚’ç½®ãå ´æ‰€ã«æ¿ã§å°ã•ãªã—ãã„ã‚’ã¤ã‘ã¦ä¸€ç–‹ã®å±±ç¾Šã‚’é£¼ã„ã¾ã—ãŸã€‚æ¯æœãã®ä¹³ã‚’ã—ã¼ã£ã¦ã¤ã‚ãŸã„ãƒ‘ãƒ³ã‚’ã²ãŸã—ã¦ãŸã¹ã€ãã‚Œã‹ã‚‰é»’ã„é©ã®ã‹ã°ã‚“ã¸ã™ã“ã—ã®æ›¸é¡ã‚„é›‘èªŒã‚’å…¥ã‚Œã€é´ã‚‚ãã‚Œã„ã«ã¿ãŒãã€ä¸¦æœ¨ã®ãƒãƒ—ãƒ©ã®å½±æ³•å¸«ã‚’å¤§è‚¡ã«ã‚ãŸã£ã¦å¸‚ã®å½¹æ‰€ã¸å‡ºã¦è¡Œãã®ã§ã—ãŸã€‚ã‚ã®ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ´ã‚©ã®ã™ãã¨ãŠã£ãŸé¢¨ã€å¤ã§ã‚‚åº•ã«å†·ãŸã•ã‚’ã‚‚ã¤é’ã„ãã‚‰ã€ã†ã¤ãã—ã„æ£®ã§é£¾ã‚‰ã‚ŒãŸãƒ¢ãƒªãƒ¼ã‚ªå¸‚ã€éƒŠå¤–ã®ãã‚‰ãã‚‰ã²ã‹ã‚‹è‰ã®æ³¢ã€‚"
    }

sample_text = "ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„"
if selected_item in aozora_dict:
    sample_text = aozora_dict[selected_item]

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢â†’ã‚µãƒ³ãƒ—ãƒ«ã¯æ–‡å­—è¡¨ç¤ºã®ã¿ã«å¤‰æ›´
st.sidebar.text("ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹")
container = st.sidebar.container(border=True)
container.write(str(sample_text)[:100] + "â€¦" if len(sample_text)>100 else sample_text)

# ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªãªã®ã§keyã‚’æ¸¡ã™
text = selected_item

# ãƒœã‚¿ãƒ³ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
if st.sidebar.button("åˆ†æé–‹å§‹"):
    if text != "":
        # FastAPIã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        response = requests.post("http://localhost:8000/analyze", json={"text": text})
        
        if response.status_code == 200:
            st.session_state.api_result = response.json()
            st.session_state.api_called = True
        else:
            st.error("APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
    else:
        st.info("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# APIã®çµæœã‚’è¡¨ç¤º
if st.session_state.api_result:

    df = pd.DataFrame(st.session_state.api_result)
    
    # æ„Ÿæƒ…ã‚«ãƒ†ã‚´ãƒª
    positive = ['å–œã³', 'æœŸå¾…']
    negative = ['æ‚²ã—ã¿', 'æ€’ã‚Š']
    natural_positive = ['é©šã']
    natural_negative = ['æã‚Œ']
    
    # æ„Ÿæƒ…ãƒªã‚¹ãƒˆã‚’å±•é–‹
    emo_df = pd.DataFrame()
    for index, row in df.iterrows():
        for emotion, score in row['scores'].items():
            emo_df.at[index, emotion] = score

    emo_df = emo_df.reindex(columns=['å–œã³', 'æœŸå¾…', 'é©šã', 'æã‚Œ', 'æ‚²ã—ã¿', 'æ€’ã‚Š'])
    
    # ãƒã‚¸ãƒ†ã‚£ãƒ–ã‹ãƒã‚¬ãƒ†ã‚£ãƒ–ã‹ã§é‡ã•ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    def calculate_sentiment_score(row):
        score = 0.5
        for emotion in positive:
            score += row.get(emotion, 0)
        for emotion in negative:
            score -= row.get(emotion, 0)
        for emotion in natural_positive:
            score += row.get(emotion, 0) / 2
        for emotion in natural_negative:
            score -= row.get(emotion, 0) / 2
        return score
    
    # dfã«æ„Ÿæƒ…ã‚«ãƒ©ãƒ¼ç”¨é‡ã¿ä»˜ãã‚¹ã‚³ã‚¢ã‚’è¿½åŠ 
    weighted = emo_df.apply(calculate_sentiment_score, axis=1)*2
    df['normalized_scores'] = (weighted - weighted.min()) / (weighted.max() - weighted.min())
    
    
    #å‡ºåŠ›ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
    st_df = pd.concat([df,emo_df],axis=1)
    st_df = st_df.drop(labels=['max_score','scores'],axis=1)
    
    st_df.rename(
        columns={
            'sentence': 'æ–‡ç« ',
            'sentiment': 'ãƒ†ãƒ³ã‚·ãƒ§ãƒ³',
            'max_label': 'æ„Ÿæƒ…',
            'normalized_scores': 'ãƒã‚¸ãƒ†ã‚£ãƒ–åº¦'
            },
        inplace=True
        )
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’CSVå½¢å¼â†’ãƒã‚¤ãƒˆå½¢å¼ã«å¤‰æ›
    csv = st_df.to_csv(index=False)
    to_write = StringIO(csv)
    
    # ãƒ—ãƒ­ãƒƒãƒˆã®ç”¨æ„
    fig = go.Figure()
    
    # xè»¸ãƒ©ãƒ™ãƒ«ã®ä½œæˆ
    def create_label(row):
        x_label = str(row.name) + "ã€€" + row['sentence'][:8]
        if len(row['sentence']) > 8:
            x_label = x_label + "â€¦"
        return x_label
    sentence_label = df.apply(create_label, axis=1)
    
    # æŠ˜ã‚Œç·šãƒãƒ£ãƒ¼ãƒˆã®è¿½åŠ 
    fig.add_trace(go.Scatter(
        x=sentence_label, 
        y=df['sentiment'],
        mode='lines',
        line=dict(color='black'),
        showlegend=False
    ))
    
    # åˆ†æ•£å›³ã®ãƒ›ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã®ç”Ÿæˆ
    hover_texts = df.apply(lambda row: 
        f"{row['sentence'][:50]}<br>" +
        f"æ„Ÿæƒ…: {row['max_label']}" +
        {"å–œã³": "ğŸ˜„", "æœŸå¾…": "ğŸ™‚", "é©šã": "ğŸ˜²", "æã‚Œ": "ğŸ˜¨", "æ‚²ã—ã¿": "ğŸ˜¢", "æ€’ã‚Š": "ğŸ˜ "}.get(row['max_label'], "") +
        "ã€€" +
        f"å¤§ãã•: {round(row['max_score']*100,1)}%<br>",
        axis=1
    ).tolist()
    
    # ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å®šç¾©
    color_scale = px.colors.sequential.Viridis
    
    # ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆã‚ã›ã¦é‡ã¿ä»˜ãã‚¹ã‚³ã‚¢ã‚’èª¿æ•´
    df.loc[(df['normalized_scores'] < 0.3) & (df['max_label'].isin(positive)), 'normalized_scores'] = 0.5
    
    # æ•£å¸ƒå›³ã®è¿½åŠ 
    fig.add_trace(go.Scatter(
        x=sentence_label, y=df['sentiment'], 
        mode='markers',
        marker=dict(
            size=df['max_score']*30, 
            color=df['normalized_scores'], 
            colorscale=color_scale,
            showscale=True,
            coloraxis='coloraxis',  # ã‚«ãƒ©ãƒ¼ã‚¢ã‚¯ã‚·ã‚¹ã®å‚ç…§ã‚’è¿½åŠ 
            ),
        text=hover_texts,  # ãƒ›ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
        hoverinfo='text'  # ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
    ))
    
    # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è¨­å®š
    fig.update_layout(
        title='æ„Ÿæƒ…æŠ˜ã‚Œç·šãƒãƒ£ãƒ¼ãƒˆ',
        xaxis_title='æ–‡ç« ',
        xaxis=dict(
            tickangle=90
            ),
        yaxis_title='ãƒ†ãƒ³ã‚·ãƒ§ãƒ³',
        yaxis=dict(
            range=(-3, 3)
            ),
        coloraxis=dict(colorscale=color_scale),
        showlegend=False,
        height=600,
        annotations=[
            dict(
                xref='paper',
                yref='paper',
                x=1.1,  # ã‚«ãƒ©ãƒ¼ãƒãƒ¼ã®ç›´ãéš£ã‚’æŒ‡ã™
                y=1,  # ã‚«ãƒ©ãƒ¼ãƒãƒ¼ã®ä¸Šéƒ¨
                text="Positive",
                showarrow=False,
                align="left"
            ),
            dict(
                xref='paper',
                yref='paper',
                x=1.1,  # ã‚«ãƒ©ãƒ¼ãƒãƒ¼ã®ç›´ãéš£ã‚’æŒ‡ã™
                y=0.15,  # ã‚«ãƒ©ãƒ¼ãƒãƒ¼ã®ä¸‹éƒ¨
                text="Negative",
                showarrow=False,
                align="left"
            )
        ]
    )

    # Streamlitã§è¡¨ç¤º
    st.header('åˆ†æçµæœ')
    
    def to_percentage(x):
        if isinstance(x, float):
            return "{:.1f}%".format(x * 100)
        return x
    
    def ActiveSentiment(sentiment):
        list_size = len(sentiment)
        # æœ€å¤§å€¤(+2)ã¨æœ€å°å€¤(-2)ã‚’å‡ç­‰ã«åˆ†é…
        # è¦ç´ æ•°ãŒå¥‡æ•°ã®å ´åˆã€ä¸­å¤®ã®å€¤ã‚’0ã«è¨­å®šï¼ˆå¹³å‡å€¤ã«è¿‘ã¥ã‘ã‚‹ãŸã‚ï¼‰
        if list_size % 2 == 0:
            # å¶æ•°ã®å ´åˆã€åŠåˆ†ã‚’æœ€å°å€¤ã€åŠåˆ†ã‚’æœ€å¤§å€¤ã«ã™ã‚‹
            scores = [-2] * (list_size // 2) + [2] * (list_size // 2)
        else:
            # å¥‡æ•°ã®å ´åˆã€æœ€å°å€¤ã¨æœ€å¤§å€¤ã®é–“ã«1ã¤0ã‚’æŒ¿å…¥
            scores = [-2] * (list_size // 2) + [0] + [2] * (list_size // 2)
        return np.std(sentiment)/np.std(scores)
    
    # ãƒã‚¸ãƒ†ã‚£ãƒ–åº¦ã®èª¬æ˜æ–‡dict
    mentality_descriptions = {
        1 : "å…¨é¢çš„ã«æ‚²è¦³çš„ã§ã™ã€‚",
        2 : "å¦å®šçš„ã§ã‚ã‚Šã€æ‚²è¦³çš„ãªè¦‹æ–¹ãŒå¼·ãå‡ºã¦ã„ã¾ã™ã€‚",
        3 : "ã»ã¼å¦å®šçš„ã§ã€æ¥½è¦³çš„è¦ç´ ãŒå°‘ãªã„ã§ã™ã€‚",
        4 : "æ‚²è¦³çš„ãªè¦‹æ–¹ãŒã‚ã‚Šã¤ã¤ã€å°‘ã—å¸Œæœ›ãŒè¦‹ãˆã¾ã™ã€‚",
        5 : "ä¸­ç«‹çš„ãªç«‹å ´ã‚’ä¿ã£ã¦ã„ã‚‹æ–‡ç« ã§ã™ã€‚",
        6 : "ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¦‹æ–¹ãŒæ„Ÿã˜ã‚‰ã‚Œã¾ã™ã€‚",
        7 : "æ˜ã‚‹ãå¸Œæœ›çš„ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚",
        8 : "éå¸¸ã«ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¦–ç‚¹ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
        9 : "æ¥µã‚ã¦å‰å‘ãã§ã€æ˜ã‚‹ã„å†…å®¹ã§ã™ã€‚"
    }

    # ãƒ†ãƒ³ã‚·ãƒ§ãƒ³åº¦ã®èª¬æ˜æ–‡dict
    tension_descriptions = {
        1 : "å‹•ããŒãªãã€å®Œå…¨ã«é™ã‹ãªçŠ¶æ…‹ã§ã™ã€‚",
        2 : "éå¸¸ã«è½ã¡ç€ã„ã¦ãŠã‚Šã€æ„Ÿæƒ…ã®èµ·ä¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
        3 : "ã‚„ã‚„ä½ã‚ã®ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã§ã€æ„Ÿæƒ…ã®èµ·ä¼ã¯ç©ã‚„ã‹ã§ã™ã€‚",
        4 : "ç©ã‚„ã‹ãªå‹•ãã§ã€è½ã¡ç€ã„ãŸé›°å›²æ°—ã§ã™ã€‚",
        5 : "æ™®é€šã®æ´»å‹•ãƒ¬ãƒ™ãƒ«ã§ã€ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ã¾ã™ã€‚",
        6 : "ã‚„ã‚„æ´»ç™ºã§ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæ„Ÿã˜ã‚‰ã‚Œã¾ã™ã€‚",
        7 : "æ´»ç™ºã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ãªæ§˜å­ãŒä¼ã‚ã‚Šã¾ã™ã€‚",
        8 : "éå¸¸ã«é«˜ã„ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã§ã€æ´»å‹•çš„ã§ã™ã€‚",
        9 : "æ¥µã‚ã¦ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã§ã€èˆˆå¥®ã—ã¦ã„ã¾ã™ã€‚"
    }
    
    mentality = df['normalized_scores'].mean()
    tension = ActiveSentiment(df['sentiment'])
    
    st.write("å…¨ä½“ã®ãƒã‚¸ãƒ†ã‚£ãƒ–åº¦ï¼š" + to_percentage(mentality))
    st.info(mentality_descriptions.get(int(np.floor((mentality*10,0))[0])))
    st.write("å…¨ä½“ã®ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ï¼š" + to_percentage(tension))
    st.info(tension_descriptions.get(int(np.floor((tension*10,0))[0])))
    
    # æ„Ÿæƒ…æŠ˜ã‚Œç·šãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤º
    st.plotly_chart(fig)
    
    # Streamlitã§ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’è¡¨ç¤º
    st.markdown('**æ–‡ç« ã”ã¨ã®æ„Ÿæƒ…ã‚¹ã‚³ã‚¢**')
    row_number = st.slider(
        "æ–‡ç« ã”ã¨ã®æ„Ÿæƒ…ã‚¹ã‚³ã‚¢", 
        min_value=1, 
        max_value=len(emo_df), 
        value=1,
        format="%dè¡Œç›®",
        label_visibility='hidden'
        )
    row_number = row_number-1
    st.write(df['sentence'][row_number])

    selected_row = emo_df.T[row_number]
    barfig = px.bar(
        selected_row,
        labels=dict(index=df['sentence'][row_number],value='æ„Ÿæƒ…ã‚¹ã‚³ã‚¢'),
        range_y=[0.0,1.0],
        color=[6,5,4,3,2,1],
        color_continuous_scale='viridis'
        )
    st.plotly_chart(barfig)
    
    #  ã‚«ãƒ©ãƒ ã®æ¯”ç‡ã‚’æŒ‡å®š
    col1, col2 = st.columns((2,1))
    
    with col1:
        # åˆ—ã”ã¨ã®å¹³å‡å€¤ã‚’è¨ˆç®—
        emo_df_mean = emo_df.mean().reset_index()
        emo_df_mean.columns = ['æ„Ÿæƒ…', 'ã‚¹ã‚³ã‚¢']
        
        # å††ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
        piefig = px.pie(emo_df_mean, names='æ„Ÿæƒ…', values='ã‚¹ã‚³ã‚¢',title='æ„Ÿæƒ…ã®å¹³å‡ã‚¹ã‚³ã‚¢ã®å‰²åˆ',
                        color='æ„Ÿæƒ…',
                        color_discrete_map={
                            "å–œã³": "#fde725",
                            "æœŸå¾…": "#b5de2b", 
                            "é©šã": "#35b779", 
                            "æã‚Œ": "#26828e", 
                            "æ‚²ã—ã¿": "#3e4989", 
                            "æ€’ã‚Š": "#440154"},
                        width=400
                        )
        st.plotly_chart(piefig)
    
    with col2:
        st.markdown('<br><br>', unsafe_allow_html=True)
        
        # max_labelã®å„å€¤ã®å‡ºç¾å›æ•°ã‚’è¨ˆç®—
        label_counts = df['max_label'].value_counts()
        # æœ€é »å€¤ã‚’å–å¾—
        mode_labels = df['max_label'].mode()
        
        mode_df = pd.DataFrame({
            'æœ€å¤§æ„Ÿæƒ…': [df.loc[df['max_score'] == df['max_score'].max(), 'max_label'].iloc[0]],
            'æœ€å¤§ã‚¹ã‚³ã‚¢':[to_percentage(df['max_score'].max())],
            'æœ€é »å€¤': ['ã€'.join(mode_labels.tolist())],
            'æœ€é »å€¤ã®ç™»å ´æ•°':label_counts.iloc[0],
        })
        st.dataframe(mode_df.T)
    
    
    st.subheader('åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰')
    st.markdown('**ãƒ‡ãƒ¼ã‚¿è©³ç´°**')
    st.dataframe(st_df.applymap(to_percentage))
    
    # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
    st.download_button(
        label="CSVå½¢å¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=to_write.getvalue(),
        file_name='emotion_data.csv',
        mime='text/csv',
    )